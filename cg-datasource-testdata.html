<link href="../../bower_components/polymer/polymer.html" rel="import">
<link href="../../bower_components/cg-datasource/cg-datasource-base.html" rel="import">

<polymer-element name="cg-datasource-testdata" extends="cg-datasource-base">
    <script>
        (function() {
            console.log("##################################################");
            console.log("cg-datasource-testdata INIT");
            console.log("##################################################");

            var labels = ["nonspillable","marcel","physiotherapy","ironmonger","pistollike","undernutrition","papillomatous","enslaving"];
            var notes = [
                "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam nunc augue, finibus malesuada orci quis, ornare bibendum nulla. Donec massa lorem, placerat at diam sit amet, vulputate sagittis lorem.",
                "Sed id lacus vitae tortor convallis rhoncus a non ipsum. Proin semper augue justo, sit amet dictum erat porttitor vitae. Cras in ornare lacus, quis facilisis sem. Sed tempus magna et ligula imperdiet gravida.",
                "Cras ut interdum diam, ut rutrum nunc. Donec augue ligula, ultricies ac purus ac, fringilla efficitur enim.",
                "Vivamus efficitur fermentum diam, sed blandit tellus viverra sit amet. Nam ut suscipit urna. Maecenas et bibendum orci.",
                "Curabitur ut mi vitae purus congue venenatis. Fusce eu enim libero. Quisque quis accumsan nibh, et pulvinar mauris. Phasellus sit amet metus at felis porta fermentum at id velit.",
                "In hac habitasse platea dictumst. Vestibulum dictum tincidunt justo eu ornare. Suspendisse aliquet arcu sem, vitae sollicitudin metus ultrices sit amet.",
                "Nulla vehicula at sapien quis ultricies. Etiam eu mauris gravida, laoreet erat ac, suscipit urna. Proin volutpat tempus magna, quis ornare velit convallis vel."
            ];
            var categories = [
                "Root canal","Pulpotomy","Apicoectomy","Prosthodontics",
                "Crowns","Veneers","Bridges","Implants","Dentures",
                "Implant-supported prosthesis","Extraction","Fiberotomy"
            ];

            var colors = [
                {name:"Bold Blue", mask:"#5484ED"},
                {name:"Blue", mask:"#A4BDFC"},
                {name:"Bold Green", mask:"#51B749"},
                {name:"Yellow", mask:"#FBD75B"},
                {name:"Red", mask:"#FF887C"},
                {name:"Bold Red", mask:"#DC2127"},
                {name:"Gray", mask:"#E1E1E1"}
            ];

            var documents = [{
                "name": "c29bf435b98b.jpg",
                "size": 359551,
                "type": "image/jpeg",
                "description":"Sed id lacus vitae tortor convallis rhoncus a non ipsum.",
                "added":new Date("2015-01-18T09:00:00.000-0500"),
                "link":23
            }, {
                "name": "docs.zip",
                "size": 1607693765,
                "type": "application/zip",
                "description":"Sed tempus magna et ligula imperdiet gravida. Proin semper augue justo, sit amet dictum erat porttitor vitae.",
                "added":new Date("2015-01-18T09:00:00.000-0500")
            }, {
                "name": "eclipse-java-luna-SR1-linux-gtk-x86_64.tar.gz",
                "size": 160242552,
                "type": "application/gzip",
                "added":new Date("2015-02-01T09:00:00.000-0500"),
                "link":56
            }, {
                "name": "jdk-8u25-linux-x64.gz",
                "size": 160872482,
                "type": "application/gzip",
                "added":new Date("2015-02-18T09:00:00.000-0500")
            }, {
                "name": "salamander",
                "size": 63,
                "type": "",
                "description":"Proin semper augue justo, sit amet dictum erat porttitor vitae.",
                "added":new Date("2015-03-20T09:00:00.000-0500"),
                "link":34
            }, {
                "name": "singlepath.svg",
                "size": 47770,
                "type": "image/svg+xml",
                "description":"Sed id lacus vitae tortor convallis rhoncus a non ipsum.",
                "added":new Date("2015-03-11T09:00:00.000-0500")
            }, {
                "name": "stock-vector-natural-grass-and-gr.jpg",
                "size": 71119,
                "type": "image/jpeg",
                "description":"Sed tempus magna et ligula imperdiet gravida.",
                "added":new Date("2015-03-14T09:00:00.000-0500"),
                "link":56
            }];


            // TEST DATA
            var id=0;
            var groupedEvents = [
                {
                    from:new Date("2015-03-18T09:00:00.000-0500"),
                    to:new Date("2015-03-18T12:30:00.000-0500")
                },
                {
                    from:new Date("2015-03-18T09:00:00.000-0500"),
                    to:new Date("2015-03-18T10:00:00.000-0500")
                },
                {
                    from:new Date("2015-03-18T10:00:00.000-0500"),
                    to:new Date("2015-03-18T11:30:00.000-0500")
                },
                {
                    from:new Date("2015-03-18T11:30:00.000-0500"),
                    to:new Date("2015-03-18T12:30:00.000-0500")
                },
                {
                    from:new Date("2015-03-18T09:30:00.000-0500"),
                    to:new Date("2015-03-18T14:30:00.000-0500")
                },
                {
                    from:new Date("2015-03-18T10:30:00.000-0500"),
                    to:new Date("2015-03-18T12:30:00.000-0500")
                },
                {
                    from:new Date("2015-03-18T11:00:00.000-0500"),
                    to:new Date("2015-03-18T13:30:00.000-0500")
                },
                {
                    from:new Date("2015-03-18T12:30:00.000-0500"),
                    to:new Date("2015-03-18T14:00:00.000-0500")
                },
                {
                    from:new Date("2015-03-18T14:00:00.000-0500"),
                    to:new Date("2015-03-18T17:00:00.000-0500")
                }
            ];

            var nonGrouped = [{
                from:new Date("2015-03-18T14:00:00.000-0500"),
                to:new Date("2015-03-18T15:00:00.000-0500")
            }];

            var multidayTemplate = [
//            {
//                from:new Date("2015-03-16T09:00:00.000-0500"),
//                to:new Date("2015-03-19T15:00:00.000-0500")
//            },
                {
                    from:new Date("2015-03-17T09:00:00.000-0500"),
                    to:new Date("2015-03-19T20:00:00.000-0500")
                }
            ];
            var rdm = function(min, max){
                min = (min||0);
                max = (max||0);
                return min + parseInt(Math.random() * (max - min));
            };
            var rdmStr = function(words, length){
                words = words.slice();
                var str = "";
                for(var i =0; i < length; i++) {
                    var index = rdm(0, words.length)
                    var word = words.splice(index, 1)[0];
                    str += word + " ";
                }
                return str;
            };
            var rdmArr = function(words, min, max){
                words = words.slice();
                var arr = [];
                var size = rdm(min || 0, max || words.length);
                for(var i =0; i < size; i++) {
                    var index = rdm(0, words.length)
                    var word = words.splice(index, 1)[0];
                    arr.push(word);
                }
                return arr;
            };
            function getShiftedDateFrom(date, days, hours){
                date = new Date(date);
                days && date.setDate(date.getDate() + days);
                hours && date.setHours(date.getHours() + hours);
                return date;
            }
            function getShiftedGroupFrom(group, days, hours){
                var shifted = [];
                group.forEach(function(event){
                    shifted.push({
                        label:rdmStr(labels, 4),
                        notes:rdmStr(notes, 4),
                        categories:rdmArr(categories),
                        documents:rdmArr(documents),
                        color:rdmArr(colors, 1, 1)[0],
                        from:getShiftedDateFrom(event.from, days, hours),
                        to:getShiftedDateFrom(event.to, days, hours),
                    });
                }.bind(this));
                return shifted;
            }
            function generateEvents(template, n, days, hours){
                var group = [];
                var shift = template;
                for(var i =0; i<n;i++){
                    shift = getShiftedGroupFrom(shift, days, hours);
                    group = group.concat(shift);
                }
                return group;
            }
//            var groupedEvents = generateEvents(getShiftedGroupFrom(groupedEvents, 0), 1, 0, 0);
            var bigGroupedGroup = generateEvents(getShiftedGroupFrom(groupedEvents, -3), 30, 0, 9);
//            var bigNonGrouped = generateEvents(getShiftedGroupFrom(nonGrouped, -3), 200, 0, 1);
//
//            this.$.agenda.date = new Date("2015-03-16T18:30:20.815Z");
//            this.$.agenda.colors = colors;
//            this.$.agenda.categories = categories;
//            this.documents = documents.slice();
//        sandbox.$.agenda.events = groupedEvents;
//        sandbox.$.agenda.events = bigEvent;
//        sandbox.$.agenda.events = bigNonGrouped;
//            this.$.agenda.events = bigGroupedGroup;
//        sandbox.$.agenda.events = multiday;

            var userEventsOverview = bigGroupedGroup.slice(0, 10);
            userEventsOverview[0].payment = true;
            userEventsOverview[2].payment = true;
            userEventsOverview[4].payment = true;

            var chartColors = [
                { r:255,g:0,  b:0 },
                { r:255,g:255,b:0 },
                { r:0,  g:255,b:0 },
                { r:0,  g:0,  b:255 },
                { r:0,  g:255,b:255 },
                { r:230,g:57, b:207 },
                { r:8  ,g:110,b:31 },
                { r:255,g:182,b:46 },
                { r:133,g:29, b:133 },

                { r:234,g:0, b:23 },
                { r:12,g:134, b:134 },
                { r:56,g:56, b:56 },
                { r:56,g:56, b:56 },
            ];

            function toCssColor(color, alpha){
                return "rgba("+color.r+","+color.g+","+color.b+","+alpha+")";
            }

            var cats = rdmArr(categories, 4, categories.length);
            var appointmentsCategories = [];
            for(var i = 0;i<cats.length;i++){
                appointmentsCategories.push({
                    value:50 + rdm(500),
                    color:toCssColor(chartColors[i], 1.0),
                    highlight:toCssColor(chartColors[i], 0.5),
                    label: cats[i]
                });
            }

            var appointmentsOverview = [{
                value:50 + rdm(500),
                color:toCssColor(chartColors[0], 1.0),
                highlight:toCssColor(chartColors[0], 0.5),
                label: "Past"
            },{
                value:50 + rdm(500),
                color:toCssColor(chartColors[1], 1.0),
                highlight:toCssColor(chartColors[1], 0.5),
                label: "To be paid"
            },{
                value:50 + rdm(500),
                color:toCssColor(chartColors[2], 1.0),
                highlight:toCssColor(chartColors[2], 0.5),
                label: "Scheduled"
            },{
                value:50 + rdm(500),
                color:toCssColor(chartColors[3], 1.0),
                highlight:toCssColor(chartColors[3], 0.5),
                label: "Cancelled"
            }];

            var yearAppointments = {
                labels: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                datasets: []
            };
            for(var i = 0; i < cats.length; i++){
                yearAppointments.datasets.push({
                    label: categories[i],
                    fillColor: toCssColor(chartColors[i], 0.5),
                    strokeColor: toCssColor(chartColors[i], 0.8),
                    highlightFill: toCssColor(chartColors[i], 0.75),
                    highlightStroke: toCssColor(chartColors[i], 1),
                    data: [rdm(10),rdm(10),rdm(10),rdm(10),rdm(10),rdm(10),rdm(10),rdm(10),rdm(10),rdm(10),rdm(10),rdm(10)]
                });
            }

            var intersects =function(e1, e2){
                var es1 = e1.from.getTime();
                var ee1 = e1.to.getTime();
                var es2 = e2.from.getTime();
                var ee2 = e2.to.getTime();
                return (es1 <= ee2 && es2 <= ee1 );
            };
            var getEventsInView = function(events, view){
                var inView = [];
                events.forEach(function(e){
                    if(intersects(e, view)){
                        inView.push(e);
                    }
                }.bind(this));
                return inView;
            };

            var orderEvents = function(events, copy){
                events = copy === false ? events : events.slice();
                events.sort(this.eventComparator);
                return events;
            };

            var eventComparator = function(a,b){
                var aFrom = a.from.getTime();
                var bFrom = b.from.getTime();
                var aTo = a.to.getTime();
                var bTo = b.to.getTime();
                return  aFrom < bFrom ? -1 : aFrom > bFrom ? 1 : aTo < bTo ? 1 : aTo > bTo ? -1 : 0;
            };

            var TestData = {
                events:bigGroupedGroup,
                userEventsOverview:userEventsOverview,
                userDocuments:documents.slice(),
                colors:colors,
                categories:categories,
                yearAppointments:yearAppointments,
                appointmentsOverview:appointmentsOverview,
                appointmentsCategories:appointmentsCategories
            };

            var returnData = function(data, callback) {
                return callback({
                    success:true,
                    data:data,
                });
            };

            Polymer({
                _mapping:null,
                created:function(){
                    this._mapping = {
                        'cg-agenda-events-in-range':this.getEventsInRange,
                        'cg-agenda-editor-color-list':this.getColors,
                        'cg-agenda-editor-tag-list':this.getCategories,
                        'cg-agenda-editor-document-list':this.getUserDocuments
                    };
                    this.super();
                },
                getProvider:function(type){
                    return this._mapping[type];
                },
                getEventsInRange:function(callback, params){
                    var range = {};
                    console.log("### Datasource[TestData] getEventsInRange(params:"+JSON.stringify(params)+")");
                    range.from = params.from.constructor == Date ? params.from : new Date(params.from);
                    range.to = params.to.constructor == Date ? params.to : new Date(params.to);
                    return returnData(orderEvents(getEventsInView(TestData.events, range), false), callback);
                },
                getUserDocuments:function(callback, params){
                    console.log("### Datasource[TestData] getUserDocuments(params:"+JSON.stringify(params)+")");
                    return returnData(TestData.userDocuments, callback);
                },
                getColors:function(callback, params){
                    console.log("### Datasource[TestData] getColors(params:"+JSON.stringify(params)+")");
                    return returnData(TestData.colors, callback);
                },
                getCategories:function(callback, params){
                    console.log("### Datasource[TestData] getCategories(params:"+JSON.stringify(params)+")");
                    return returnData(TestData.categories, callback);
                }
            });
        })();
    </script>
</polymer-element>